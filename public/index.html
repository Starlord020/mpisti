<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SÃ¼per PiÅŸti Pro</title>
    <style>
        :root {
            --bg-dark: #0a2912;
            --bg-light: #1a5c2b;
            --gold-mid: #fccd4d;
            --glass-bg: rgba(0, 0, 0, 0.85);
            --speaking-glow: #2ecc71;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            /* ESKÄ° GÃœZEL YEÅžÄ°L TASARIM */
            background: radial-gradient(circle at center, var(--bg-light) 0%, var(--bg-dark) 100%);
            color: #eee; margin: 0; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column; user-select: none;
        }

        .screen { display: none; height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: rgba(10, 41, 18, 0.98); z-index: 20; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }

        /* SAÄž ÃœST BUTONLAR */
        .top-btn { 
            position: fixed; top: 15px; width: 45px; height: 45px; 
            border-radius: 50%; border: 1px solid #555; cursor: pointer; 
            z-index: 200; font-size: 20px; background: rgba(0,0,0,0.6); color: white;
            display: flex; align-items: center; justify-content: center;
        }
        #fs-btn { right: 15px; } 
        #mic-btn { right: 70px; }
        #share-btn { right: 125px; background: #3498db; }
        #leave-btn { left: 15px; background: #c0392b; border-color: #e74c3c; }

        .mic-active { background: #e74c3c !important; box-shadow: 0 0 15px #e74c3c; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.6; } }

        /* OYUN ALANI */
        #game-board { display: grid; grid-template-columns: 80px 1fr 80px; grid-template-rows: 1fr 2fr 1fr; width: 100%; height: 100%; padding: 5px; box-sizing: border-box; }
        .seat { display: flex; align-items: center; justify-content: center; position: relative; }
        #seat-top { grid-column: 2; grid-row: 1; }
        #seat-left { grid-column: 1; grid-row: 2; }
        #seat-right { grid-column: 3; grid-row: 2; }
        #seat-bottom { grid-column: 2; grid-row: 3; align-items: flex-end; padding-bottom: 10px; }

        .seat-content { display: flex; flex-direction: column; align-items: center; width: 100%; }
        
        /* BÄ°LGÄ° KUTUSU */
        .info-box { 
            background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 8px; border: 1px solid #444; 
            min-width: 80px; text-align: center; color: white; font-size: 12px; transition: all 0.2s; 
            display: flex; flex-direction: column; align-items: center;
        }
        .speaking-box { border: 2px solid var(--speaking-glow) !important; box-shadow: 0 0 15px var(--speaking-glow); }
        .active-turn-box { border: 2px solid var(--gold-mid) !important; box-shadow: 0 0 15px var(--gold-mid); }

        /* BOÅž KOLTUK */
        .empty-seat {
            width: 60px; height: 60px; border-radius: 50%; border: 2px dashed #777;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #aaa; font-size: 24px; transition: 0.2s;
        }
        .empty-seat:hover { background: rgba(255,255,255,0.1); border-color: var(--gold-mid); color: var(--gold-mid); }

        /* KARTLAR */
        .my-card { width: 100px; margin-left: -45px; border-radius: 6px; box-shadow: 0 2px 8px #000; transition: transform 0.1s; will-change: transform; cursor: pointer; }
        .my-card:first-child { margin-left: 0; }
        .my-turn .my-card:hover { transform: translateY(-30px); z-index: 20; }
        .opponent-card { width: 35px; border-radius: 3px; border: 1px solid #999; margin-left: -22px; }
        .center-card { width: 90px; position: absolute; border-radius: 6px; box-shadow: 2px 2px 5px #000; transition: transform 0.3s; }
        .flying-card { position: fixed; z-index: 9999; transition: transform 0.5s ease-out, opacity 0.5s; pointer-events: none; margin:0!important; }

        /* PANELLER & GÄ°RÄ°Åž */
        .glass-panel { background: var(--glass-bg); border-radius: 15px; padding: 20px; border: 1px solid #444; width: 90%; max-width: 400px; text-align: center; }
        input { padding: 12px; margin: 10px; border-radius: 20px; background: #222; color: white; border: 1px solid #555; text-align: center; width: 70%; font-size: 16px; }
        button { padding: 12px 25px; margin: 5px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-green { background: #27ae60; color: white; }
        .btn-red { background: #c0392b; color: white; }
        .btn-gold { background: var(--gold-mid); color: black; box-shadow: 0 4px 10px rgba(241, 196, 15, 0.3); }

        #admin-panel { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; display: none; z-index: 150; }

        @media (max-width: 600px) {
            #game-board { grid-template-columns: 50px 1fr 50px; }
            .my-card { width: 75px; margin-left: -30px; } .center-card { width: 70px; }
        }
    </style>
</head>
<body>
    <button id="fs-btn" class="top-btn" onclick="toggleFS()">â›¶</button>
    <button id="mic-btn" class="top-btn" onclick="toggleMic()">ðŸŽ¤</button>
    <button id="share-btn" class="top-btn" onclick="copyLink()" style="display:none;">ðŸ”—</button>
    
    <div id="game-ui" style="display:none;">
        <button id="leave-btn" class="top-btn" onclick="leave()">ðŸšª</button>
    </div>

    <div id="login-screen" class="screen active">
        <h1 style="color:var(--gold-mid); font-size: 3rem; text-shadow: 0 3px 5px black; margin-bottom: 20px;">â™  PÄ°ÅžTÄ° PRO â™¦</h1>
        <p id="invite-msg" style="color:#3498db; display:none; margin-bottom:10px;">Masaya davetlisiniz!</p>
        
        <input type="text" id="username" placeholder="Oyuncu AdÄ±nÄ±zÄ± Girin">
        
        <div style="color:#ccc; font-size:13px; margin:15px; text-align:left; display:inline-block;">
            <label style="display:block; margin-bottom:5px;"><input type="checkbox" id="chk-age"> 18 yaÅŸÄ±ndan bÃ¼yÃ¼ÄŸÃ¼m</label>
            <label><input type="checkbox" id="chk-terms"> KurallarÄ± kabul ediyorum</label>
        </div>
        <br>
        <button class="btn-gold" style="width: 200px;" onclick="login()">GÄ°RÄ°Åž YAP</button>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="glass-panel" style="height:80%; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #555; padding-bottom:10px;">
                <h2 style="margin:0; color:var(--gold-mid);">LOBÄ°</h2>
                <button class="btn-green" onclick="document.getElementById('create-modal').style.display='flex'">+ MASA</button>
            </div>
            <div id="room-list" style="flex:1; overflow-y:auto; text-align:left;"></div>
        </div>
    </div>

    <div id="create-modal" class="screen" style="background:rgba(0,0,0,0.9);">
        <div class="glass-panel">
            <h3 style="color:white;">Masa AdÄ±</h3>
            <input type="text" id="room-name">
            <br>
            <button class="btn-green" onclick="createRoom()">OLUÅžTUR</button>
            <button class="btn-red" onclick="document.getElementById('create-modal').style.display='none'">Ä°PTAL</button>
        </div>
    </div>

    <div id="game-screen" class="screen" style="background:transparent;">
        <div id="notif" style="display:none; position:fixed; top:40%; background:rgba(0,0,0,0.9); padding:20px; border-radius:10px; z-index:100; color:gold;">TUR BÄ°TTÄ°</div>

        <div id="admin-panel">
            <button class="btn-green" onclick="startGame()">OYUNU BAÅžLAT</button>
            <div style="font-size:11px; margin-top:5px; color:#aaa;">(BoÅŸ yerlere bot gelir)</div>
        </div>

        <div id="game-board">
            <div id="seat-top" class="seat"><div class="seat-content" id="content-top"></div></div>
            <div id="seat-left" class="seat"><div class="seat-content" id="content-left"></div></div>
            <div id="center-zone"><div style="border: 2px dashed #555; width: 90px; height: 130px; border-radius: 8px;"></div></div>
            <div id="seat-right" class="seat"><div class="seat-content" id="content-right"></div></div>
            <div id="seat-bottom" class="seat"><div class="seat-content" id="content-bottom"></div></div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div class="glass-panel">
            <h1 id="win-text" style="color:var(--gold-mid);">SONUÃ‡</h1>
            <div style="font-size:20px; margin:20px; border:1px solid #555; padding:10px; border-radius:10px;">
                <p id="res-a" style="color:#3498db">TakÄ±m A: 0</p>
                <p id="res-b" style="color:#e74c3c">TakÄ±m B: 0</p>
            </div>
            <button class="btn-green" onclick="leave()">Ã‡IKIÅž</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let curRoom="", myIdx=-1, myName="", isMuted=true;
        let audioCtx, mediaRec, lastState = null;
        let inviteCode = null;

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            inviteCode = urlParams.get('oda');
            if(inviteCode) {
                document.getElementById('invite-msg').innerText = `"${inviteCode}" masasÄ±na girilecek.`;
                document.getElementById('invite-msg').style.display = 'block';
            }
        };

        function getSrc(s,v) { return `/img/${{'â™¥':'hearts','â™¦':'diamonds','â™£':'clubs','â™ ':'spades'}[s]}_${v}.png`; }
        function toggleFS() { document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen(); }
        
        function copyLink() {
            const link = `${window.location.origin}/?oda=${curRoom}`;
            navigator.clipboard.writeText(link).then(() => alert("Link kopyalandÄ±!"));
        }

        // --- SES MOTORU ---
        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
        
        async function toggleMic() {
            initAudio();
            const btn = document.getElementById('mic-btn');
            if(isMuted) {
                try {
                    if(location.protocol!=='https:' && location.hostname!=='localhost') { alert("HTTPS Gerekli"); return; }
                    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                    let options = { mimeType: 'audio/webm;codecs=opus' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) options = {};
                    
                    mediaRec = new MediaRecorder(stream, options);
                    mediaRec.ondataavailable = e => { if(e.data.size>0 && curRoom) socket.emit("voice", {roomId:curRoom, blob:e.data}); };
                    mediaRec.start(250); 
                    isMuted=false; btn.classList.add('mic-active');
                    socket.emit("speaking", {roomId:curRoom, isSpeaking:true});
                } catch(e) { alert("Mikrofon hatasÄ±: " + e); }
            } else {
                if(mediaRec) mediaRec.stop();
                isMuted=true; btn.classList.remove('mic-active');
                socket.emit("speaking", {roomId:curRoom, isSpeaking:false});
            }
        }

        socket.on("voice", async blob => {
            if(isMuted) return; initAudio();
            try { const b = await blob.arrayBuffer(); const a = await audioCtx.decodeAudioData(b); const s = audioCtx.createBufferSource(); s.buffer=a; s.connect(audioCtx.destination); s.start(0); } catch(e){}
        });

        socket.on("playerSpeaking", d => {
            if(!lastState) return;
            let sIdx = parseInt(Object.keys(lastState.seats).find(k => lastState.seats[k] && lastState.seats[k].id === d.id));
            if(isNaN(sIdx)) return;
            let el = document.querySelector(`#c-${getPos(sIdx)} .info-box`);
            if(el) d.isSpeaking ? el.classList.add('speaking-box') : el.classList.remove('speaking-box');
        });

        // --- OYUN AKIÅžI ---
        function login() {
            let u = document.getElementById('username').value;
            if(!u || !document.getElementById('chk-age').checked || !document.getElementById('chk-terms').checked) return alert("Bilgileri doldurun");
            myName = u;
            initAudio(); 

            if(inviteCode) {
                socket.emit('joinRoom', {roomId: inviteCode, username: myName});
            } else {
                show('lobby-screen');
            }
        }

        function show(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        
        function createRoom() {
            let r = document.getElementById('room-name').value;
            if(r) { socket.emit('createRoom', {roomId:r, username:myName}); document.getElementById('create-modal').style.display='none'; }
        }
        function join(id) { socket.emit('joinRoom', {roomId:id, username:myName}); }
        function leave() { 
            if(confirm("Masadan kalkmak istiyor musunuz?")) { 
                socket.emit('leaveRoom'); 
                window.history.pushState({}, document.title, "/");
                location.reload(); 
            } 
        }
        function sit(i) { socket.emit('sitDown', {roomId:curRoom, seatIndex:i, username:myName}); }
        function startGame() { socket.emit('startGame', curRoom); }

        socket.on('roomList', l => {
            let d=document.getElementById('room-list'); d.innerHTML="";
            if(l.length===0) d.innerHTML="<p style='color:#777; text-align:center;'>Masa yok.</p>";
            l.forEach(r => d.innerHTML+=`<div style="padding:15px; background:rgba(255,255,255,0.1); margin:5px; border-radius:10px; cursor:pointer; display:flex; justify-content:space-between;" onclick="join('${r.id}')"><b>${r.id}</b> <span>${r.count}/4</span></div>`);
        });

        socket.on('errorMsg', msg => { alert(msg); show('lobby-screen'); });

        socket.on('joined', d => {
            curRoom = d.roomId; myIdx = d.mySeat; 
            show('game-screen');
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('share-btn').style.display = 'flex';
            document.getElementById('admin-panel').style.display = d.isAdmin ? 'block' : 'none';
            const newUrl = `${window.location.origin}/?oda=${curRoom}`;
            window.history.pushState({path:newUrl},'',newUrl);
        });

        socket.on('updateRoom', r => render(r));
        socket.on('gameStarted', r => { document.getElementById('admin-panel').style.display='none'; render(r); });
        socket.on('updateGame', r => render(r));
        socket.on('matchOver', d => { show('result-screen'); document.getElementById('win-text').innerText=d.winner+" KAZANDI"; document.getElementById('res-a').innerText="A: "+d.scoreA; document.getElementById('res-b').innerText="B: "+d.scoreB; });

        function render(room) {
            lastState = room;
            let vBase = myIdx === -1 ? 0 : myIdx; 
            
            draw(0, 'bottom', vBase, room);
            draw(1, 'right', vBase, room);
            draw(2, 'top', vBase, room);
            draw(3, 'left', vBase, room);

            let c = document.querySelector('#center-zone div'); c.innerHTML="";
            room.centerPile.forEach((card, i) => {
                let img = document.createElement('img'); img.src = getSrc(card.suit, card.value);
                img.className = 'center-card'; img.style.transform = `rotate(${(i*10)%360}deg)`;
                c.appendChild(img);
            });
        }

        function draw(offset, pos, vBase, room) {
            let actualIdx = (vBase + offset) % 4;
            let player = room.seats[actualIdx];
            let div = document.getElementById(`content-${pos}`);
            
            if(!room.gameStarted && player === null) {
                div.innerHTML = `<div class="empty-seat" onclick="sit(${actualIdx})">+</div><div style="font-size:10px; color:#aaa;">BoÅŸ</div>`;
                return;
            }
            if(player === null) { div.innerHTML = ""; return; }

            let isTurn = room.gameStarted && room.turnIndex === actualIdx;
            let turnClass = isTurn ? 'active-turn-box' : '';
            
            let handHtml = `<div class="hand-container" style="height:50px; display:flex; justify-content:center; margin-top:5px;">`;
            if(actualIdx === myIdx) { 
                handHtml = `<div id="my-hand">`;
                player.hand.forEach((card, i) => {
                    let clk = isTurn ? `onclick="play(this, ${i})"` : "";
                    handHtml += `<img src="${getSrc(card.suit,card.value)}" class="my-card" ${clk}>`;
                });
                handHtml += `</div>
                <div style="font-size:10px; margin-top:5px; width:100%; display:flex; justify-content:space-between;">
                    <span style="color:#3498db">A: ${room.totalScoreA}</span> <span style="color:#e74c3c">B: ${room.totalScoreB}</span>
                </div>`;
            } else { 
                for(let k=0; k<player.hand.length; k++) handHtml += `<img src="/img/back_light.png" class="opponent-card">`;
                handHtml += `</div>`;
            }

            div.innerHTML = `<div id="c-${pos}"><div class="info-box ${turnClass}"><span style="font-weight:bold; color:${isTurn?'#f1c40f':'white'};">${player.name}</span></div></div>${handHtml}`;
        }

        function play(el, i) {
            let cl = el.cloneNode(true); cl.classList.add('flying-card'); cl.classList.remove('my-card');
            let r = el.getBoundingClientRect(); let c = document.querySelector('#center-zone div').getBoundingClientRect();
            cl.style.left=r.left+'px'; cl.style.top=r.top+'px'; document.body.appendChild(cl);
            requestAnimationFrame(()=>{ cl.style.transform=`translate(${c.left-r.left+10}px, ${c.top-r.top+10}px) rotate(360deg) scale(0.8)`; cl.style.opacity=0; });
            setTimeout(()=>cl.remove(),500);
            socket.emit('playCard', {roomId:curRoom, cardIndex:i});
        }

        function getPos(idx) {
            let vBase = myIdx===-1?0:myIdx;
            if(idx===vBase) return 'bottom';
            if(idx===(vBase+1)%4) return 'right';
            if(idx===(vBase+2)%4) return 'top';
            return 'left';
        }
    </script>
</body>
</html>
