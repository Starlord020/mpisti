<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SÃ¼per PiÅŸti Pro</title>
    <style>
        :root {
            --bg-dark: #0a2912;
            --bg-light: #1a5c2b;
            --gold-mid: #fccd4d;
            --glass-bg: rgba(0, 0, 0, 0.85);
            --speaking-glow: #2ecc71; /* YeÅŸil IÅŸÄ±k */
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: radial-gradient(circle at center, var(--bg-light) 0%, var(--bg-dark) 100%);
            color: #eee;
            margin: 0; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column; user-select: none;
        }

        .screen { display: none; height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: rgba(10, 41, 18, 0.98); z-index: 20; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }

        /* YEÅžÄ°L KONUÅžMA EFEKTÄ° */
        @keyframes speakPulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); border-color: #2ecc71; }
            50% { box-shadow: 0 0 20px 5px rgba(46, 204, 113, 0.4); transform: scale(1.05); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); border-color: #2ecc71; }
        }
        .speaking-box {
            animation: speakPulse 1s infinite;
            border: 2px solid var(--speaking-glow) !important;
            background: rgba(46, 204, 113, 0.2) !important;
        }

        /* SARI SIRA EFEKTÄ° */
        .active-turn-box { border: 2px solid var(--gold-mid) !important; box-shadow: 0 0 15px var(--gold-mid); }

        /* DÄ°ÄžER CSS */
        .info-box { background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 8px; border: 1px solid #444; min-width: 80px; text-align: center; color: white; font-size: 12px; transition: all 0.2s; }
        .flying-card { position: fixed; z-index: 9999; transition: transform 0.5s ease-out, opacity 0.5s; pointer-events: none; box-shadow: 2px 2px 10px rgba(0,0,0,0.5); will-change: transform; margin: 0 !important; }
        .glass-panel { background: var(--glass-bg); border-radius: 15px; padding: 20px; border: 1px solid #444; }
        
        #game-board { display: grid; grid-template-columns: 80px 1fr 80px; grid-template-rows: 1fr 2fr 1fr; width: 100%; height: 100%; padding: 5px; }
        .seat { display: flex; align-items: center; justify-content: center; position: relative; }
        #seat-top { grid-column: 2; grid-row: 1; } #seat-left { grid-column: 1; grid-row: 2; } #seat-right { grid-column: 3; grid-row: 2; } #seat-bottom { grid-column: 2; grid-row: 3; align-items: flex-end; }
        .seat-content { display: flex; flex-direction: column; align-items: center; }
        #seat-top .seat-content { transform: rotate(180deg); } #seat-left .seat-content { transform: rotate(90deg); } #seat-right .seat-content { transform: rotate(-90deg); }

        .my-card { width: 100px; margin-left: -45px; border-radius: 6px; box-shadow: 0 2px 8px #000; transition: transform 0.1s; }
        .my-card:first-child { margin-left: 0; }
        .my-turn .my-card:hover { transform: translateY(-20px); z-index: 20; }
        .opponent-card { width: 35px; border-radius: 3px; border: 1px solid #999; margin-left: -22px; }
        .center-card { width: 90px; position: absolute; border-radius: 6px; box-shadow: 2px 2px 5px #000; }
        
        #my-hand { display: flex; height: 140px; align-items: flex-end; justify-content: center; }
        #center-zone { grid-column: 2; grid-row: 2; display: flex; justify-content: center; align-items: center; position: relative; }
        #center-zone div { border: 2px dashed #555; width: 90px; height: 130px; border-radius: 8px; }

        input { padding: 12px; margin: 10px; border-radius: 20px; border: 1px solid #555; background: #222; color: white; text-align: center; }
        button { padding: 12px 20px; margin: 5px; border-radius: 20px; border: none; cursor: pointer; background: var(--gold-mid); font-weight: bold; }
        .btn-red { background: #c0392b; color: white; } .btn-green { background: #27ae60; color: white; }
        
        #mic-btn, #fs-btn { position: absolute; top: 10px; width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; z-index: 100; font-size: 20px; background: rgba(0,0,0,0.5); color: white; }
        #mic-btn { right: 60px; } #fs-btn { right: 10px; }
        .mic-on { background: #e74c3c !important; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.6; } }
        
        @media (max-width: 600px) {
            #game-board { grid-template-columns: 50px 1fr 50px; }
            .my-card { width: 75px; margin-left: -30px; } .center-card { width: 70px; } .opponent-card { width: 25px; margin-left: -15px; }
        }
    </style>
</head>
<body>
    <button id="fs-btn" onclick="toggleFS()">â›¶</button>
    <button id="mic-btn" onclick="toggleMic()">ðŸŽ¤</button>

    <div id="login-screen" class="screen active">
        <h1 style="color:var(--gold-mid);">â™  PÄ°ÅžTÄ° PRO â™¦</h1>
        <input type="text" id="username" placeholder="Oyuncu AdÄ±">
        <div style="color:#ccc; font-size:12px; text-align:left; margin:10px;">
            <label><input type="checkbox" id="chk-age"> 18+ yaÅŸÄ±ndayÄ±m.</label><br>
            <label><input type="checkbox" id="chk-terms"> KurallarÄ± kabul ediyorum.</label>
        </div>
        <button onclick="login()">GÄ°RÄ°Åž YAP</button>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="glass-panel" style="width:90%; max-width:500px; height:80%; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between;"><h2>MASALAR</h2><button class="btn-green" onclick="showCreate()">+ MASA</button></div>
            <div id="room-list" style="flex:1; overflow-y:auto; margin-top:10px;"></div>
        </div>
    </div>

    <div id="create-modal" class="screen" style="background:rgba(0,0,0,0.9);">
        <div class="glass-panel" style="text-align:center;">
            <h3>Masa AdÄ±</h3><input type="text" id="room-name">
            <br><button class="btn-green" onclick="createRoom()">OLUÅžTUR</button><button class="btn-red" onclick="closeCreate()">Ä°PTAL</button>
        </div>
    </div>

    <div id="game-screen" class="screen" style="background:transparent;">
        <button class="btn-red" style="position:absolute; top:10px; left:10px; z-index:100; padding:5px 10px;" onclick="leave()">ðŸšª</button>
        <div id="notif" style="display:none; position:fixed; top:40%; background:rgba(0,0,0,0.9); padding:20px; border-radius:10px; z-index:100; color:gold;">TUR BÄ°TTÄ°</div>

        <div id="game-board">
            <div id="seat-top" class="seat"><div class="seat-content"><div class="info-box"><span id="name-top">...</span></div><div id="hand-top"></div></div></div>
            <div id="seat-left" class="seat"><div class="seat-content"><div class="info-box"><span id="name-left">...</span></div><div id="hand-left"></div></div></div>
            <div id="center-zone"><div></div></div>
            <div id="seat-right" class="seat"><div class="seat-content"><div class="info-box"><span id="name-right">...</span></div><div id="hand-right"></div></div></div>
            <div id="seat-bottom" class="seat">
                <div class="seat-content">
                    <div id="my-hand"></div>
                    <div class="info-box" style="min-width:150px; margin-top:5px;">
                        <div style="font-weight:bold; color:var(--gold-mid);">BEN</div>
                        <div id="turn-msg" style="font-size:11px;">...</div>
                        <div style="display:flex; justify-content:space-between; font-size:11px;">
                            <span id="score-a" style="color:#3498db">A: 0</span><span id="score-b" style="color:#e74c3c">B: 0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="waiting-overlay" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; background:rgba(0,0,0,0.8); padding:20px; border-radius:10px; display:none;">
            <h3>Oyuncu Bekleniyor...</h3>
            <div id="admin-panel" style="display:none;"><button onclick="addBot()">+ BOT</button><button class="btn-green" onclick="startGame()">BAÅžLAT</button></div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div class="glass-panel" style="text-align:center;">
            <h1 id="win-text" style="color:gold;">SONUÃ‡</h1>
            <p id="res-a">A: 0</p><p id="res-b">B: 0</p>
            <button class="btn-green" onclick="leave()">Ã‡IKIÅž</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let curRoom="", myIdx=-1, myName="", audioCtx, mediaRec, isMuted=true;
        let lastState = null;

        // --- GÃ–RSEL ---
        function getSrc(s,v) { return `/img/${{'â™¥':'hearts','â™¦':'diamonds','â™£':'clubs','â™ ':'spades'}[s]}_${v}.png`; }
        function toggleFS() { document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen(); }

        // --- SES SÄ°STEMÄ° (WEB AUDIO API) ---
        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
        
        async function toggleMic() {
            initAudio();
            const btn = document.getElementById('mic-btn');
            if(isMuted) {
                try {
                    if(location.protocol!=='https:' && location.hostname!=='localhost') { alert("HTTPS Gerekli!"); return; }
                    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                    mediaRec = new MediaRecorder(stream, {mimeType:'audio/webm;codecs=opus'});
                    mediaRec.ondataavailable = e => { if(e.data.size>0 && curRoom) socket.emit("voice", {roomId:curRoom, blob:e.data}); };
                    mediaRec.start(200); 
                    isMuted=false; btn.classList.add('mic-on');
                    socket.emit("speaking", {roomId:curRoom, isSpeaking:true});
                } catch(e) { alert(e); }
            } else {
                if(mediaRec) mediaRec.stop();
                isMuted=true; btn.classList.remove('mic-on');
                socket.emit("speaking", {roomId:curRoom, isSpeaking:false});
            }
        }

        socket.on("voice", async (blob) => {
            if(isMuted) return;
            initAudio();
            try {
                const buf = await blob.arrayBuffer();
                const aud = await audioCtx.decodeAudioData(buf);
                const src = audioCtx.createBufferSource();
                src.buffer = aud; src.connect(audioCtx.destination); src.start(0);
            } catch(e){}
        });

        socket.on("playerSpeaking", (data) => {
            if(!lastState) return;
            let p = lastState.players.find(x => x.id === data.id);
            if(!p) return;
            let idx = lastState.players.indexOf(p);
            let pos = getPos(idx, lastState.players.length);
            
            // KonuÅŸanÄ±n kutusuna YEÅžÄ°L efekt ver
            let box = document.querySelector(`#seat-${pos} .info-box`);
            if(data.isSpeaking) box.classList.add('speaking-box');
            else box.classList.remove('speaking-box');
        });

        // --- OYUN AKIÅžI ---
        function login() {
            let u = document.getElementById('username').value;
            if(!u || !document.getElementById('chk-age').checked) { alert("Eksik bilgi!"); return; }
            myName = u;
            show('lobby-screen');
            initAudio(); // Kilidi aÃ§
        }
        function show(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function showCreate() { document.getElementById('create-modal').classList.add('active'); }
        function closeCreate() { document.getElementById('create-modal').classList.remove('active'); }
        
        function createRoom() {
            let r = document.getElementById('room-name').value;
            if(r) { socket.emit('createRoom', {roomId:r, username:myName}); closeCreate(); }
        }
        function join(id) { socket.emit('joinRoom', {roomId:id, username:myName}); }
        function leave() { if(confirm("Ã‡Ä±kÄ±ÅŸ?")) { socket.emit('leaveRoom'); location.reload(); } }
        function addBot() { socket.emit('addBot', curRoom); }
        function startGame() { socket.emit('startGame', curRoom); }

        // --- SOCKET ---
        socket.on('roomList', list => {
            let d = document.getElementById('room-list'); d.innerHTML="";
            list.forEach(r => {
                d.innerHTML += `<div style="padding:10px; background:rgba(255,255,255,0.1); margin:5px; cursor:pointer;" onclick="join('${r.id}')"><b>${r.id}</b> (${r.count}/4)</div>`;
            });
        });

        socket.on('joined', d => {
            curRoom = d.roomId; myIdx = d.myIndex;
            show('game-screen');
            document.getElementById('waiting-overlay').style.display='block';
            if(d.isAdmin) document.getElementById('admin-panel').style.display='block';
        });

        socket.on('updateRoom', r => {
            // Bekleme ekranÄ± listesi (basit)
            // Oyuna baÅŸlayÄ±nca burasÄ± gizleniyor
        });

        socket.on('gameStarted', r => {
            document.getElementById('waiting-overlay').style.display='none';
            render(r);
        });
        socket.on('updateGame', r => render(r));
        socket.on('roundOver', () => { document.getElementById('notif').style.display='block'; setTimeout(()=>document.getElementById('notif').style.display='none',2000); });
        socket.on('matchOver', d => {
            show('result-screen');
            document.getElementById('win-text').innerText = d.winner + " KAZANDI!";
            document.getElementById('res-a').innerText = "A: "+d.scoreA; document.getElementById('res-b').innerText = "B: "+d.scoreB;
        });

        function render(room) {
            lastState = room;
            let self = room.players[myIdx];
            let turn = room.turnIndex === myIdx;
            
            document.getElementById('turn-msg').innerText = turn ? "SIRA SENDE" : "BEKLENÄ°YOR";
            document.getElementById('turn-msg').style.color = turn ? "#2ecc71" : "#777";
            document.getElementById('score-a').innerText = `A: ${room.totalScoreA}`;
            document.getElementById('score-b').innerText = `B: ${room.totalScoreB}`;

            // SIRA KÄ°MDEYSE SARI YAK
            ['top','left','right','bottom'].forEach(p => {
                let el = document.querySelector(`#seat-${p} .info-box`);
                el.classList.remove('active-turn-box');
            });

            if(room.players.length===4) {
                updSeat('right', room.players[(myIdx+1)%4], room.turnIndex===(myIdx+1)%4);
                updSeat('top', room.players[(myIdx+2)%4], room.turnIndex===(myIdx+2)%4);
                updSeat('left', room.players[(myIdx+3)%4], room.turnIndex===(myIdx+3)%4);
            } else {
                updSeat('top', room.players[(myIdx+1)%2], room.turnIndex===(myIdx+1)%2);
            }

            let myBox = document.querySelector('#seat-bottom .info-box');
            if(turn) myBox.classList.add('active-turn-box');

            // ELÄ°M
            let h = document.getElementById('my-hand'); h.innerHTML="";
            if(turn) h.classList.add('my-turn'); else h.classList.remove('my-turn');
            self.hand.forEach((c,i) => {
                let img = document.createElement('img'); img.src = getSrc(c.suit,c.value); img.className='my-card';
                if(turn) img.onclick = () => { anim(img); socket.emit('playCard', {roomId:curRoom, cardIndex:i}); };
                h.appendChild(img);
            });

            // ORTA
            let cen = document.querySelector('#center-zone div'); cen.innerHTML="";
            room.centerPile.forEach((c,i) => {
                let img = document.createElement('img'); img.src = getSrc(c.suit,c.value); img.className='center-card';
                img.style.transform=`rotate(${(i*15)%360}deg)`;
                cen.appendChild(img);
            });
        }

        function updSeat(pos, p, isTurn) {
            if(!p) return;
            document.getElementById(`name-${pos}`).innerText = p.name;
            let box = document.querySelector(`#seat-${pos} .info-box`);
            if(isTurn) box.classList.add('active-turn-box');
            
            let h = document.getElementById(`hand-${pos}`); h.innerHTML="";
            for(let i=0; i<p.hand.length; i++) {
                let img = document.createElement('img'); img.src="/img/back_light.png"; img.className='opponent-card';
                h.appendChild(img);
            }
        }

        function anim(el) {
            let cl = el.cloneNode(true); cl.classList.add('flying-card');
            let r = el.getBoundingClientRect();
            let c = document.getElementById('center-zone').getBoundingClientRect();
            cl.style.left=r.left+'px'; cl.style.top=r.top+'px';
            document.body.appendChild(cl);
            requestAnimationFrame(()=>{
                cl.style.transform = `translate(${c.left-r.left+10}px, ${c.top-r.top+10}px) rotate(360deg) scale(0.8)`;
                cl.style.opacity='0';
            });
            setTimeout(()=>cl.remove(), 500);
        }

        function getPos(idx, total) {
            if(idx===myIdx) return 'self';
            if(total===2) return 'top';
            if(idx===(myIdx+1)%4) return 'right';
            if(idx===(myIdx+2)%4) return 'top';
            return 'left';
        }
    </script>
</body>
</html>
