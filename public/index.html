<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SÃ¼per PiÅŸti Pro</title>
    <style>
        :root {
            --bg-dark: #0a2912;
            --bg-light: #1a5c2b;
            --gold: #f1c40f;
            --glass: rgba(0,0,0,0.85);
        }
        body { font-family: sans-serif; background: radial-gradient(circle, var(--bg-light), var(--bg-dark)); margin:0; height:100vh; overflow:hidden; color:white; user-select:none; }
        
        .screen { display:none; position:absolute; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:20; flex-direction:column; align-items:center; justify-content:center; }
        .active { display:flex; }

        /* BUTONLAR (SAÄž ÃœST SABÄ°T) */
        .top-btn { position:fixed; top:10px; width:40px; height:40px; border-radius:50%; border:1px solid #555; background:rgba(0,0,0,0.6); color:white; z-index:100; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; }
        #fs-btn { right:10px; }
        #mic-btn { right:60px; }
        #leave-btn { left:10px; background:#c0392b; }
        .mic-active { background:#e74c3c !important; box-shadow:0 0 10px red; }

        /* OYUN ALANI (GRID SÄ°STEMÄ° - KAYMAZ) */
        #game-board { 
            display: grid; 
            grid-template-columns: 100px 1fr 100px; 
            grid-template-rows: 120px 1fr 160px; /* Sabit yÃ¼kseklikler */
            width:100%; height:100%; box-sizing:border-box; padding:5px;
        }

        /* KOLTUKLAR */
        .seat { position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        #seat-top { grid-column:2; grid-row:1; }
        #seat-left { grid-column:1; grid-row:2; }
        #seat-right { grid-column:3; grid-row:2; }
        #seat-bottom { grid-column:2; grid-row:3; justify-content:flex-end; }

        /* ORTA ALAN */
        #center-zone { grid-column:2; grid-row:2; display:flex; justify-content:center; align-items:center; position:relative; }
        #center-zone div { width:90px; height:130px; border:2px dashed rgba(255,255,255,0.2); border-radius:8px; }

        /* KARTLAR VE KUTULAR */
        .info-box { background:rgba(0,0,0,0.8); padding:5px; border-radius:5px; border:1px solid #555; text-align:center; font-size:12px; min-width:80px; z-index:5; }
        .speaking { border-color:#2ecc71; box-shadow:0 0 10px #2ecc71; }
        .turn-active { border-color:var(--gold); box-shadow:0 0 10px var(--gold); }

        .empty-seat { width:60px; height:60px; border:2px dashed #777; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:30px; color:#777; cursor:pointer; }
        .empty-seat:hover { border-color:var(--gold); color:var(--gold); }

        /* KART STÄ°LLERÄ° */
        .hand-container { display:flex; justify-content:center; margin-top:5px; height: 50px; }
        .opponent-card { width:35px; margin-left:-25px; border-radius:3px; border:1px solid #999; background:white; }
        
        #my-hand { display:flex; height:140px; align-items:flex-end; justify-content:center; }
        .my-card { width:100px; margin-left:-50px; border-radius:6px; box-shadow:0 2px 5px black; transition:transform 0.1s; cursor:pointer; }
        .my-card:first-child { margin-left:0; }
        .my-card:hover { transform:translateY(-20px); }
        
        .center-card { width:90px; position:absolute; border-radius:6px; box-shadow:0 2px 5px black; transition:transform 0.2s; }
        .flying { position:fixed; z-index:9999; transition:0.5s ease-out; pointer-events:none; }

        /* DÄ°ÄžER UI */
        .glass-panel { background:var(--glass); padding:20px; border-radius:15px; border:1px solid #444; width:90%; max-width:400px; text-align:center; }
        input { padding:10px; width:70%; margin:10px; background:#222; border:1px solid #555; color:white; text-align:center; border-radius:10px; }
        button { padding:10px 20px; border-radius:10px; border:none; cursor:pointer; font-weight:bold; margin:5px; }
        .btn-g { background:#27ae60; color:white; } .btn-r { background:#c0392b; color:white; } .btn-y { background:var(--gold); color:black; }

        #admin-panel { position:absolute; bottom:50%; left:50%; transform:translate(-50%,-50%); z-index:50; display:none; }
    </style>
</head>
<body>
    <button id="fs-btn" class="top-btn" onclick="toggleFS()">â›¶</button>
    <button id="mic-btn" class="top-btn" onclick="toggleMic()">ðŸŽ¤</button>
    
    <div id="login-screen" class="screen active">
        <h1 style="color:var(--gold)">â™  PÄ°ÅžTÄ° PRO â™¦</h1>
        <input type="text" id="username" placeholder="Oyuncu AdÄ±">
        <div style="font-size:12px; color:#aaa; margin:10px;">
            <label><input type="checkbox" id="chk1"> 18+ YaÅŸÄ±ndayÄ±m</label><br>
            <label><input type="checkbox" id="chk2"> KurallarÄ± Kabul Ediyorum</label>
        </div>
        <button class="btn-y" onclick="login()">GÄ°RÄ°Åž YAP</button>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="glass-panel" style="height:80%; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between;"><h2>LOBÄ°</h2><button class="btn-g" onclick="openCreate()">+ MASA</button></div>
            <div id="room-list" style="flex:1; overflow-y:auto; margin-top:10px;"></div>
        </div>
    </div>

    <div id="create-modal" class="screen" style="background:rgba(0,0,0,0.9);">
        <div class="glass-panel">
            <h3>Masa AdÄ±</h3><input type="text" id="room-name">
            <br><button class="btn-g" onclick="createRoom()">KUR</button><button class="btn-r" onclick="document.getElementById('create-modal').classList.remove('active')">Ä°PTAL</button>
        </div>
    </div>

    <div id="game-screen" class="screen" style="background:transparent;">
        <button id="leave-btn" class="top-btn" onclick="leave()">ðŸšª</button>
        
        <div id="admin-panel">
            <button class="btn-g" style="padding:15px 30px; font-size:18px;" onclick="startGame()">OYUNU BAÅžLAT</button>
            <div style="font-size:12px; margin-top:5px; background:rgba(0,0,0,0.5); padding:5px;">(BoÅŸ yerlere otomatik bot gelir)</div>
        </div>

        <div id="game-board">
            <div id="seat-top" class="seat"><div id="c-top"></div></div>
            <div id="seat-left" class="seat"><div id="c-left"></div></div>
            <div id="center-zone"><div></div></div>
            <div id="seat-right" class="seat"><div id="c-right"></div></div>
            <div id="seat-bottom" class="seat"><div id="c-bottom"></div></div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div class="glass-panel">
            <h1 id="win-text" style="color:var(--gold)">BÄ°TTÄ°</h1>
            <p id="res-a">A: 0</p><p id="res-b">B: 0</p>
            <button class="btn-g" onclick="leave()">TAMAM</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let curRoom="", myIdx=-1, myName="", audioCtx, mediaRec, isMuted=true, lastState=null;

        function getSrc(s,v) { return `/img/${{'â™¥':'hearts','â™¦':'diamonds','â™£':'clubs','â™ ':'spades'}[s]}_${v}.png`; }
        function toggleFS() { document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen(); }

        // --- SES SÄ°STEMÄ° ---
        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
        async function toggleMic() {
            initAudio();
            if(isMuted) {
                try {
                    if(location.protocol!=='https:' && location.hostname!=='localhost') { alert("HTTPS Gerekli"); return; }
                    const s = await navigator.mediaDevices.getUserMedia({audio:true});
                    mediaRec = new MediaRecorder(s, {mimeType:'audio/webm;codecs=opus'});
                    mediaRec.ondataavailable = e => { if(e.data.size>0 && curRoom) socket.emit("voice", {roomId:curRoom, blob:e.data}); };
                    mediaRec.start(250); isMuted=false; document.getElementById('mic-btn').classList.add('mic-active');
                    socket.emit("speaking", {roomId:curRoom, isSpeaking:true});
                } catch(e) { alert(e); }
            } else {
                if(mediaRec) mediaRec.stop(); isMuted=true; document.getElementById('mic-btn').classList.remove('mic-active');
                socket.emit("speaking", {roomId:curRoom, isSpeaking:false});
            }
        }
        socket.on("voice", async blob => {
            if(isMuted) return; initAudio();
            try { const b = await blob.arrayBuffer(); const a = await audioCtx.decodeAudioData(b); const s = audioCtx.createBufferSource(); s.buffer=a; s.connect(audioCtx.destination); s.start(0); } catch(e){}
        });
        socket.on("playerSpeaking", d => {
            if(!lastState) return;
            let sIdx = parseInt(Object.keys(lastState.seats).find(k => lastState.seats[k] && lastState.seats[k].id === d.id));
            if(isNaN(sIdx)) return;
            let el = document.querySelector(`#c-${getPos(sIdx)} .info-box`);
            if(el) d.isSpeaking ? el.classList.add('speaking') : el.classList.remove('speaking');
        });

        // --- OYUN ---
        function login() {
            let u = document.getElementById('username').value;
            if(!u || !document.getElementById('chk1').checked) return alert("Bilgileri doldurun");
            myName=u; show('lobby-screen'); initAudio();
        }
        function show(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function openCreate() { document.getElementById('create-modal').classList.add('active'); }
        
        function createRoom() {
            let r = document.getElementById('room-name').value;
            if(r) { socket.emit('createRoom', {roomId:r, username:myName}); document.getElementById('create-modal').classList.remove('active'); }
        }
        function join(id) { socket.emit('joinRoom', {roomId:id, username:myName}); }
        function leave() { if(confirm("Ã‡Ä±kÄ±ÅŸ?")) { socket.emit('leaveRoom'); location.reload(); } }
        function sit(i) { socket.emit('sitDown', {roomId:curRoom, seatIndex:i, username:myName}); }
        function startGame() { socket.emit('startGame', curRoom); }

        socket.on('roomList', l => {
            let d=document.getElementById('room-list'); d.innerHTML="";
            l.forEach(r => d.innerHTML+=`<div style="padding:15px; background:rgba(255,255,255,0.1); margin:5px; cursor:pointer;" onclick="join('${r.id}')"><b>${r.id}</b> (${r.count}/4)</div>`);
        });

        socket.on('joined', d => {
            curRoom=d.roomId; myIdx=d.mySeat; show('game-screen');
            document.getElementById('admin-panel').style.display = d.isAdmin ? 'block' : 'none';
        });

        socket.on('updateRoom', r => render(r));
        socket.on('gameStarted', r => { document.getElementById('admin-panel').style.display='none'; render(r); });
        socket.on('updateGame', r => render(r));
        socket.on('matchOver', d => { show('result-screen'); document.getElementById('win-text').innerText=d.winner+" KAZANDI"; document.getElementById('res-a').innerText="A: "+d.scoreA; document.getElementById('res-b').innerText="B: "+d.scoreB; });

        function render(room) {
            lastState = room;
            let vBase = myIdx === -1 ? 0 : myIdx; // Ä°zleyiciysek 0. koltuÄŸu baz al
            
            draw(0, 'bottom', vBase, room); // Ben (veya izlenen)
            draw(1, 'right', vBase, room);
            draw(2, 'top', vBase, room);
            draw(3, 'left', vBase, room);

            // Orta
            let c = document.querySelector('#center-zone div'); c.innerHTML="";
            room.centerPile.forEach((card, i) => {
                let img = document.createElement('img'); img.src = getSrc(card.suit, card.value);
                img.className = 'center-card'; img.style.transform = `rotate(${(i*10)%360}deg)`;
                c.appendChild(img);
            });
        }

        function draw(offset, pos, vBase, room) {
            let actualIdx = (vBase + offset) % 4; // GerÃ§ek koltuk ID'si
            let player = room.seats[actualIdx];
            let div = document.getElementById(`c-${pos}`);
            
            // BoÅŸ Koltuk
            if(!room.gameStarted && player === null) {
                div.innerHTML = `<div class="empty-seat" onclick="sit(${actualIdx})">+</div>`;
                return;
            }
            if(player === null) { div.innerHTML = ""; return; }

            // Oyuncu Var
            let isTurn = room.gameStarted && room.turnIndex === actualIdx;
            let boxClass = isTurn ? 'turn-active' : '';
            
            let handHtml = `<div class="hand-container">`;
            if(actualIdx === myIdx) { // Benim elim
                handHtml = `<div id="my-hand">`;
                player.hand.forEach((card, i) => {
                    let clk = isTurn ? `onclick="play(this, ${i})"` : "";
                    handHtml += `<img src="${getSrc(card.suit,card.value)}" class="my-card" ${clk}>`;
                });
                handHtml += `</div>
                <div style="font-size:10px; margin-top:5px; width:100%; display:flex; justify-content:space-between;">
                    <span style="color:#3498db">A: ${room.totalScoreA}</span> <span style="color:#e74c3c">B: ${room.totalScoreB}</span>
                </div>`;
            } else { // Rakip
                for(let k=0; k<player.hand.length; k++) handHtml += `<img src="/img/back_light.png" class="opponent-card">`;
                handHtml += `</div>`;
            }

            div.innerHTML = `<div class="info-box ${boxClass}"><b>${player.name}</b></div>${handHtml}`;
        }

        function play(el, i) {
            let cl = el.cloneNode(true); cl.classList.add('flying');
            let r = el.getBoundingClientRect(); let c = document.querySelector('#center-zone div').getBoundingClientRect();
            cl.style.left=r.left+'px'; cl.style.top=r.top+'px'; document.body.appendChild(cl);
            requestAnimationFrame(()=>{ cl.style.transform=`translate(${c.left-r.left+10}px, ${c.top-r.top+10}px) rotate(360deg) scale(0.8)`; cl.style.opacity=0; });
            setTimeout(()=>cl.remove(),500);
            socket.emit('playCard', {roomId:curRoom, cardIndex:i});
        }

        function getPos(idx) {
            let vBase = myIdx===-1?0:myIdx;
            if(idx===vBase) return 'bottom';
            if(idx===(vBase+1)%4) return 'right';
            if(idx===(vBase+2)%4) return 'top';
            return 'left';
        }
    </script>
</body>
</html>
