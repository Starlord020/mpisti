<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SÃ¼per PiÅŸti Pro</title>
    <style>
        :root {
            --bg-dark: #051c0b;
            --bg-light: #0d3b16;
            --gold: #f1c40f;
            --glass: rgba(0, 0, 0, 0.9);
        }
        
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            background: radial-gradient(circle at center, var(--bg-light) 0%, var(--bg-dark) 100%);
            background-color: var(--bg-dark);
            font-family: 'Segoe UI', sans-serif;
            color: white; user-select: none; overflow: hidden;
        }
        
        .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 20; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, var(--bg-light) 0%, var(--bg-dark) 100%); }
        .active { display: flex; }

        /* MENÃœ */
        #menu-container { position: fixed; top: 15px; right: 15px; z-index: 200; display: flex; flex-direction: column; align-items: flex-end; }
        .menu-btn { 
            width: 45px; height: 45px; border-radius: 50%; border: 1px solid #555; 
            cursor: pointer; font-size: 20px; background: rgba(0,0,0,0.6); color: white; 
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
            margin-bottom: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .menu-btn:active { transform: scale(0.95); }
        #hidden-menu { display: none; flex-direction: column; margin-top: 5px; }
        .menu-open #hidden-menu { display: flex; }
        .active-btn { background: #2ecc71 !important; border-color: #2ecc71; box-shadow: 0 0 10px #2ecc71; }
        .leave-btn { background: #c0392b !important; border-color: #e74c3c; }

        /* OYUN ALANI */
        #game-board { 
            display: grid; 
            grid-template-columns: 80px 1fr 80px; 
            grid-template-rows: 100px 1fr 140px; 
            width: 100%; height: 100%; padding: 5px; box-sizing: border-box; 
        }
        
        .seat { display: flex; align-items: center; justify-content: center; position: relative; }
        #seat-top { grid-column: 2; grid-row: 1; align-items: flex-start; padding-top: 10px; }
        #seat-left { grid-column: 1; grid-row: 2; justify-content: flex-start; padding-left: 5px; }
        #seat-right { grid-column: 3; grid-row: 2; justify-content: flex-end; padding-right: 5px; }
        #seat-bottom { grid-column: 2; grid-row: 3; align-items: flex-end; padding-bottom: 10px; }
        
        #content-bottom { display: flex; flex-direction: row; align-items: flex-end; gap: 15px; }
        .seat-content { display: flex; flex-direction: column; align-items: center; }

        /* OYUNCU KUTUSU (SABÄ°T BOYUT) */
        .player-box {
            width: 70px; height: 70px; /* Sabit boyut */
            background: #111; border: 2px solid #444; border-radius: 10px; 
            position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s; flex-shrink: 0; /* KÃ¼Ã§Ã¼lmeyi engelle */
        }
        .player-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .player-box.has-cam img { display: block; }
        .player-name { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); font-size: 10px; text-align: center; padding: 2px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; }
        .mic-icon { position: absolute; top: 2px; right: 2px; font-size: 12px; display: none; background: rgba(0,0,0,0.6); border-radius: 50%; padding: 3px; z-index: 3;}
        .speaking { border-color: #2ecc71 !important; box-shadow: 0 0 10px #2ecc71; }
        .turn-active { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }

        /* Ben (Alt) Kamera */
        #content-bottom .player-box { width: 80px; height: 80px; }
        /* Rakipler Kamera (BÃ¼yÃ¼k) */
        .seat:not(#seat-bottom) .player-box.has-cam { width: 130px; height: 130px; z-index: 50; box-shadow: 0 5px 20px black; }

        /* KARTLAR */
        .my-card { width: 110px; margin-left: -60px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.6); cursor: pointer; transition: transform 0.2s; }
        .my-card:first-child { margin-left: 0; }
        .my-card:hover { transform: translateY(-30px) scale(1.05); margin-right: 10px; z-index: 10; }
        .opponent-card { width: 40px; border-radius: 4px; border: 1px solid #aaa; margin-left: -25px; background: white; }
        
        #center-zone { grid-column: 2; grid-row: 2; display: flex; justify-content: center; align-items: center; position: relative; }
        #center-target { width: 100px; height: 140px; border: 2px dashed rgba(255,255,255,0.15); border-radius: 8px; position: relative; }
        .center-card { width: 100px; position: absolute; top:0; left:0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .flying-card { position: fixed; z-index: 9999; transition: transform 0.5s ease-out; pointer-events: none; width: 100px; margin:0!important; }

        /* BOÅž KOLTUK */
        .empty-seat { width: 60px; height: 60px; border: 2px dashed #777; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #aaa; font-size: 24px; transition: 0.2s; }
        .empty-seat:hover { border-color: var(--gold); color: var(--gold); background: rgba(255,255,255,0.1); }

        /* DÄ°ÄžER UI */
        .btn-green { background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-red { background: #c0392b; color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn-gold { background: linear-gradient(180deg, #f1c40f 0%, #b7950b 100%); border: none; padding: 15px 50px; border-radius: 30px; color: #3e2723; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 15px; }
        .login-input { background: rgba(0, 0, 0, 0.4); border: 1px solid #2a5c35; padding: 15px; border-radius: 25px; color: white; text-align: center; font-size: 16px; width: 280px; margin-bottom: 15px; }
        
        #scoreboard-modal, .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 300; display: none; align-items: center; justify-content: center; }
        .glass-panel { background: var(--glass); border: 1px solid #444; border-radius: 15px; padding: 20px; width: 90%; max-width: 400px; text-align: center; }
        .score-board { background: #222; border: 2px solid var(--gold); padding: 25px; border-radius: 15px; text-align: center; width: 280px; }
        .score-row { display: flex; justify-content: space-between; margin: 10px 0; border-bottom: 1px solid #444; padding: 5px; font-size: 18px; }

        canvas { display: none; }

        /* MOBÄ°L DÃœZELTMELERÄ° */
        @media (max-width: 600px) {
            #game-board { grid-template-columns: 60px 1fr 60px; grid-template-rows: 80px 1fr 140px; padding: 2px; }
            .my-card { width: 90px; margin-left: -35px; }
            .center-card, .flying-card { width: 80px; }
            #center-target { width: 80px; height: 110px; }
            .seat:not(#seat-bottom) .player-box.has-cam { width: 90px; height: 90px; }
            .opponent-card { width: 30px; margin-left: -20px; }
            #seat-top { padding-top: 20px; }
            #seat-bottom { display: block; padding: 0; }
            #content-bottom { display: block; text-align: center; width: 100%; }
            #content-bottom .player-box { position: fixed !important; bottom: 15px !important; left: 15px !important; z-index: 100; margin: 0; }
            #my-hand { display: inline-flex; justify-content: center; padding-left: 60px; padding-bottom: 15px; }
        }
    </style>
</head>
<body>

    <div id="menu-container">
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <div id="hidden-menu">
            <button id="share-btn" class="menu-btn" onclick="copyLink()" style="display:none; background:#3498db; border-color:#2980b9;">ðŸ”—</button>
            <button id="cam-btn" class="menu-btn" onclick="toggleCam()">ðŸ“·</button>
            <button id="mic-btn" class="menu-btn" onclick="toggleMic()">ðŸŽ¤</button>
            <button id="fs-btn" class="menu-btn" onclick="toggleFS()">â›¶</button>
            <button id="leave-btn" class="menu-btn leave-btn" onclick="leave()" style="display:none;">ðŸšª</button>
        </div>
    </div>

    <div id="scoreboard-modal"><div class="score-board"><h2 style="color:var(--gold); margin:0;">TUR SONUCU</h2><div class="score-row"><span style="color:#3498db">TakÄ±m A</span><span id="sb-score-a">0</span></div><div class="score-row"><span style="color:#e74c3c">TakÄ±m B</span><span id="sb-score-b">0</span></div><div style="margin-top:15px; font-size:12px; color:#aaa;">Yeni tur baÅŸlÄ±yor...</div></div></div>
    <div id="terms-modal" class="modal-overlay"><div class="glass-panel" style="background:#fff; color:#333;"><span style="position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer;" onclick="closeModal()">Ã—</span><h3>SÃ¶zleÅŸme</h3><div style="text-align:left; font-size:14px;">1. EÄŸlence amaÃ§lÄ±dÄ±r.<br>2. KÃ¼fÃ¼r yasaktÄ±r.</div></div></div>

    <div id="login-screen" class="screen active">
        <h1 class="logo-text" style="margin-bottom:20px;">â™  PÄ°ÅžTÄ° PRO â™¦</h1>
        <p id="invite-msg" style="color:#3498db; display:none;">Davetlisiniz!</p>
        <input type="text" id="username" class="login-input" placeholder="Oyuncu AdÄ±nÄ±zÄ± Girin">
        <div style="text-align:left; font-size:13px; width:280px; margin-top:10px; color:#aaa;">
            <label style="display:flex;align-items:center;margin-bottom:5px;"><input type="checkbox" id="chk-age" style="margin-right:10px;"> 18 yaÅŸÄ±ndan bÃ¼yÃ¼ÄŸÃ¼m.</label>
            <label style="display:flex;align-items:center;"><input type="checkbox" id="chk-terms" style="margin-right:10px;"> <span><span style="color:var(--gold);text-decoration:underline;cursor:pointer;" onclick="openTerms()">SÃ¶zleÅŸme</span>'yi kabul ediyorum.</span></label>
        </div>
        <button class="btn-main" onclick="login()">GÄ°RÄ°Åž YAP</button>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="glass-panel" style="height:80%; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #555; padding-bottom:10px;">
                <h2 style="margin:0; color:var(--gold);">LOBÄ°</h2>
                <button class="btn-green" onclick="document.getElementById('create-modal').style.display='flex'">+ MASA</button>
            </div>
            <div id="room-list" style="flex:1; overflow-y:auto; text-align:left;"></div>
        </div>
    </div>

    <div id="create-modal" class="modal-overlay">
        <div class="glass-panel" style="background:#222; border:1px solid var(--gold);">
            <h3>Masa AdÄ±</h3><input type="text" id="room-name" class="login-input"><br><br>
            <button class="btn-green" onclick="createRoom()">OLUÅžTUR</button>
            <button class="btn-red" onclick="document.getElementById('create-modal').style.display='none'">Ä°PTAL</button>
        </div>
    </div>

    <div id="game-screen" class="screen" style="background:transparent;">
        <div id="admin-panel" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); display:none; z-index:50;">
            <button class="btn-green" style="padding:15px 40px; font-size:18px;" onclick="startGame()">OYUNU BAÅžLAT</button>
        </div>

        <div id="game-board">
            <div id="seat-top" class="seat"><div class="seat-content" id="content-top"></div></div>
            <div id="seat-left" class="seat"><div class="seat-content" id="content-left"></div></div>
            <div id="center-zone"><div id="center-target"></div></div>
            <div id="seat-right" class="seat"><div class="seat-content" id="content-right"></div></div>
            <div id="seat-bottom" class="seat"><div id="content-bottom"></div></div>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div class="glass-panel">
            <h1 id="win-text" style="color:var(--gold);">BÄ°TTÄ°</h1>
            <div style="font-size:20px; margin:20px; border:1px solid #555; padding:10px;">
                <p id="res-a" style="color:#3498db">TakÄ±m A: 0</p><p id="res-b" style="color:#e74c3c">TakÄ±m B: 0</p>
            </div>
            <button class="btn-green" onclick="leave()">Ã‡IKIÅž</button>
        </div>
    </div>

    <canvas id="cam-canvas" width="100" height="100"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let curRoom="", myIdx=-1, myName="", lastState = null, inviteCode = null;
        let audioCtx, mediaRec, localStream;
        let isMuted=true, isCamOn=false;
        let mutedUsers = new Set();
        let camDataStore = {}; // KameralarÄ± hafÄ±zada tutmak iÃ§in

        // HERHANGÄ° BÄ°R TIKLAMADA SESÄ° AÃ‡ (TARAYICI KÄ°LÄ°DÄ° Ä°Ã‡Ä°N)
        document.body.addEventListener('click', () => {
            if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            if(audioCtx.state==='suspended') audioCtx.resume();
        }, {once:true});

        window.onload = () => {
            const p = new URLSearchParams(window.location.search);
            inviteCode = p.get('oda');
            if(inviteCode) { document.getElementById('invite-msg').style.display='block'; }
        };

        function toggleMenu() { document.getElementById('menu-container').classList.toggle('menu-open'); }
        function getSrc(s,v) { return `/img/${{'â™¥':'hearts','â™¦':'diamonds','â™£':'clubs','â™ ':'spades'}[s]}_${v}.png`; }
        function toggleFS() { document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen(); toggleMenu(); }
        function copyLink() { navigator.clipboard.writeText(`${window.location.origin}/?oda=${curRoom}`).then(()=>alert("Link kopyalandÄ±!")); toggleMenu(); }
        function openTerms() { document.getElementById('terms-modal').style.display='flex'; }
        function closeModal() { document.getElementById('terms-modal').style.display='none'; }

        // --- SES (BLOB) ---
        function toggleMic() {
            if(isMuted) {
                navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                    localStream = s;
                    mediaRec = new MediaRecorder(s, {mimeType:'audio/webm;codecs=opus'});
                    mediaRec.ondataavailable = e => { if(e.data.size>0 && curRoom && !isMuted) socket.emit("streamData", {roomId:curRoom, type:'audio', payload:e.data}); };
                    mediaRec.start(200);
                    isMuted=false; document.getElementById('mic-btn').classList.add('active-btn');
                    socket.emit("speaking", {roomId:curRoom, isSpeaking:true});
                }).catch(e => alert("Mikrofon hatasÄ±: "+e));
            } else {
                if(mediaRec) mediaRec.stop();
                if(localStream) localStream.getTracks().forEach(t=>t.stop());
                isMuted=true; document.getElementById('mic-btn').classList.remove('active-btn');
                socket.emit("speaking", {roomId:curRoom, isSpeaking:false});
            }
            toggleMenu();
        }

        // --- KAMERA ---
        async function toggleCam() {
            if(!isCamOn) {
                try {
                    const s = await navigator.mediaDevices.getUserMedia({video:{width:100, height:100}});
                    const tr = s.getVideoTracks()[0];
                    const capt = new ImageCapture(tr);
                    isCamOn = true; document.getElementById('cam-btn').classList.add('active-btn');
                    window.camInt = setInterval(async ()=>{
                        if(!isCamOn) return;
                        try {
                            const bmp = await capt.grabFrame();
                            const cvs = document.getElementById('cam-canvas');
                            const ctx = cvs.getContext('2d');
                            ctx.drawImage(bmp,0,0,100,100);
                            const b64 = cvs.toDataURL('image/jpeg', 0.4);
                            socket.emit("streamData", {roomId:curRoom, type:'video', payload:b64});
                            // Kendi kameramÄ±zÄ± da gÃ¶sterelim
                            if(myIdx !== -1) {
                                camDataStore[myIdx] = b64;
                                updCam(getPos(myIdx), b64);
                            }
                        } catch(e){}
                    }, 500);
                } catch(e){ alert("Kamera hatasÄ±: "+e); }
            } else {
                isCamOn=false; document.getElementById('cam-btn').classList.remove('active-btn');
                clearInterval(window.camInt);
                socket.emit("streamData", {roomId:curRoom, type:'video', payload:null});
                if(myIdx !== -1) {
                    camDataStore[myIdx] = null;
                    updCam(getPos(myIdx), null);
                }
            }
            toggleMenu();
        }

        socket.on("streamData", d => {
            if(mutedUsers.has(d.id)) return;
            if(d.type==='audio' && !isMuted) {
                const blob = new Blob([d.payload], {type: 'audio/webm;codecs=opus'});
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play().then(() => setTimeout(() => URL.revokeObjectURL(audio.src), 1000)).catch(e=>{});
            } else if(d.type==='video') {
                if(!lastState) return;
                let idx = parseInt(Object.keys(lastState.seats).find(k=>lastState.seats[k] && lastState.seats[k].id===d.id));
                if(!isNaN(idx)) {
                    camDataStore[idx] = d.payload; // HafÄ±zaya al
                    updCam(getPos(idx), d.payload);
                }
            }
        });

        // KAMERA GÃœNCELLEME (GÃ–RÃœNTÃœ YOKSA KUTU KÃœÃ‡ÃœK KALIR)
        function updCam(pos, data) {
            let div = document.querySelector(pos==='bottom' ? '#content-bottom .player-box' : `#content-${pos} .player-box`);
            if(!div) return;
            let img = div.querySelector('img');
            
            if(data) {
                img.src = data;
                div.classList.add('has-cam');
            } else {
                img.src = "";
                div.classList.remove('has-cam');
            }
        }

        function toggleMute(id, pos) {
            if(id===socket.id) return;
            if(mutedUsers.has(id)) { mutedUsers.delete(id); document.querySelector(pos==='bottom' ? '#content-bottom .mic-icon' : `#content-${pos} .mic-icon`).style.display='none'; }
            else { mutedUsers.add(id); let icon = document.querySelector(pos==='bottom' ? '#content-bottom .mic-icon' : `#content-${pos} .mic-icon`); icon.style.display='block'; icon.innerText='ðŸ”‡'; }
        }

        // --- OYUN Ä°ÅžLEMLERÄ° ---
        function login() {
            let u=document.getElementById('username').value, a=document.getElementById('chk-age').checked, t=document.getElementById('chk-terms').checked;
            if(!u) return alert("Ä°sim giriniz."); if(!a) return alert("YaÅŸ onayÄ± gerekli."); if(!t) return alert("SÃ¶zleÅŸme onayÄ± gerekli.");
            myName=u; 
            if(inviteCode) socket.emit('joinRoom', {roomId:inviteCode, username:myName}); else show('lobby-screen');
        }

        function show(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function createRoom() { let r=document.getElementById('room-name').value; if(r){ socket.emit('createRoom', {roomId:r, username:myName}); document.getElementById('create-modal').style.display='none'; } }
        function join(id) { socket.emit('joinRoom', {roomId:id, username:myName}); }
        function leave() { if(confirm("Ã‡Ä±kÄ±ÅŸ?")) { socket.emit('leaveRoom'); location.href="/"; } toggleMenu(); }
        function sit(i) { socket.emit('sitDown', {roomId:curRoom, seatIndex:i, username:myName}); }
        function startGame() { socket.emit('startGame', curRoom); }

        socket.on('roomList', l => {
            let d=document.getElementById('room-list'); d.innerHTML="";
            if(l.length===0) d.innerHTML="<p style='color:#aaa;text-align:center'>Masa yok</p>";
            l.forEach(r => d.innerHTML+=`<div style="padding:15px; background:rgba(255,255,255,0.1); margin:5px; border-radius:10px; cursor:pointer; display:flex; justify-content:space-between;" onclick="join('${r.id}')"><b>${r.id}</b> <span>${r.count}/4</span></div>`);
        });

        socket.on('joined', d => {
            curRoom=d.roomId; myIdx=d.mySeat;
            show('game-screen'); 
            document.getElementById('share-btn').style.display='flex';
            document.getElementById('leave-btn').style.display='flex';
            document.getElementById('admin-panel').style.display = d.isAdmin ? 'block' : 'none';
            window.history.pushState({path:`/?oda=${curRoom}`},'',`/?oda=${curRoom}`);
        });

        socket.on('updateRoom', r => render(r));
        socket.on('gameStarted', r => { document.getElementById('admin-panel').style.display='none'; render(r); });
        socket.on('updateGame', r => render(r));
        socket.on('roundOver', d => {
            document.getElementById('scoreboard-modal').style.display='flex';
            document.getElementById('sb-score-a').innerText = `${d.scoreA} (+${d.lastRoundA})`;
            document.getElementById('sb-score-b').innerText = `${d.scoreB} (+${d.lastRoundB})`;
            setTimeout(()=>document.getElementById('scoreboard-modal').style.display='none', 5000);
        });
        socket.on('matchOver', d => { show('result-screen'); document.getElementById('win-text').innerText=d.winner+" KAZANDI"; document.getElementById('res-a').innerText="A: "+d.scoreA; document.getElementById('res-b').innerText="B: "+d.scoreB; });

        function render(room) {
            lastState = room;
            let vBase = myIdx===-1?0:myIdx;
            
            // KoltuklarÄ± Ã‡iz
            drawSeat(0, 'bottom', vBase, room);
            drawSeat(1, 'right', vBase, room);
            drawSeat(2, 'top', vBase, room);
            drawSeat(3, 'left', vBase, room);

            // Orta AlanÄ± Ã‡iz (KartlarÄ±)
            let c = document.getElementById('center-target'); c.innerHTML="";
            room.centerPile.forEach((card,i)=>{
                let img=document.createElement('img'); img.src=getSrc(card.suit,card.value);
                img.className='center-card'; 
                let rot = (i * 15) % 360; 
                img.style.transform = `rotate(${rot}deg)`;
                c.appendChild(img);
            });
        }

        // AKILLI KOLTUK Ã‡Ä°ZÄ°MÄ° (KAMERA KUTUSUNU BOZMADAN GÃœNCELLE)
        function drawSeat(offset, pos, vBase, room) {
            let actual = (vBase+offset)%4;
            let p = room.seats[actual];
            let div = document.getElementById(pos === 'bottom' ? 'content-bottom' : `content-${pos}`);
            
            // EÄŸer koltuk boÅŸsa
            if(!room.gameStarted && p===null) { 
                div.innerHTML=`<div class="empty-seat" onclick="sit(${actual})">+</div><div style="font-size:10px; color:#aaa; margin-top:5px;">BoÅŸ</div>`; return; 
            }
            if(p===null) { div.innerHTML=""; return; }

            // Oyuncu Var. Kutuyu bul veya oluÅŸtur.
            let pBox = div.querySelector('.player-box');
            if(!pBox) {
                // Ä°lk defa Ã§iziliyor
                let avatar = p.isBot ? "/img/bot_avatar.png" : "/img/user_placeholder.png";
                div.innerHTML = `
                    <div class="player-box" onclick="toggleMute('${p.id}','${pos}')" id="pbox-${actual}">
                        <img src="" alt="">
                        <div class="player-name">${p.name}</div>
                        <div class="mic-icon">ðŸ”‡</div>
                    </div>
                    <div class="hand-wrapper" id="hand-${actual}"></div>
                `;
                pBox = div.querySelector('.player-box');
                
                // KayÄ±tlÄ± kamera verisi varsa geri yÃ¼kle
                if(camDataStore[actual]) updCam(pos, camDataStore[actual]);
            }

            // Sadece SÄ±nÄ±flarÄ± ve Eli GÃ¼ncelle (Kutuyu silme!)
            let turnClass = (room.gameStarted && room.turnIndex===actual) ? 'turn-active' : '';
            // Mevcut sÄ±nÄ±flarÄ± koru, turn-active'i yÃ¶net
            if(turnClass) pBox.classList.add('turn-active'); else pBox.classList.remove('turn-active');

            // Eli GÃ¼ncelle
            let handHtml=`<div style="height:50px; display:flex; justify-content:center; margin-top:5px;" id="my-hand">`;
            if(actual===myIdx) {
                p.hand.forEach((c,i)=>{
                   let clk = (room.gameStarted && room.turnIndex===actual) ? `onclick="play(this,${i})"` : "";
                   handHtml+=`<img src="${getSrc(c.suit,c.value)}" class="my-card" ${clk}>`;
                });
            } else {
                for(let k=0; k<p.hand.length; k++) handHtml+=`<img src="/img/back_light.png" class="opponent-card">`;
            }
            handHtml+=`</div>`;
            
            div.querySelector('.hand-wrapper').innerHTML = handHtml;
        }

        function play(el, i) {
            let cl = el.cloneNode(true); cl.classList.add('flying-card'); cl.classList.remove('my-card');
            let r = el.getBoundingClientRect(); 
            let c = document.getElementById('center-target').getBoundingClientRect();
            cl.style.left=r.left+'px'; cl.style.top=r.top+'px'; document.body.appendChild(cl);
            requestAnimationFrame(()=>{
                let tx = c.left + (c.width/2) - (r.width/2);
                let ty = c.top + (c.height/2) - (r.height/2);
                cl.style.transform = `translate(${tx-r.left}px, ${ty-r.top}px) rotate(360deg)`;
                cl.style.opacity=0;
            });
            setTimeout(()=>cl.remove(),500);
            socket.emit('playCard', {roomId:curRoom, cardIndex:i});
        }
        
        socket.on("playerSpeaking", d => {
            if(!lastState) return;
            let idx = parseInt(Object.keys(lastState.seats).find(k=>lastState.seats[k] && lastState.seats[k].id===d.id));
            if(!isNaN(idx)) {
                let el = document.querySelector(`#pbox-${idx}`);
                if(el) d.isSpeaking ? el.classList.add('speaking') : el.classList.remove('speaking');
            }
        });

        function getPos(idx) {
            let v = myIdx===-1?0:myIdx;
            if(idx===v) return 'bottom'; if(idx===(v+1)%4) return 'right'; if(idx===(v+2)%4) return 'top'; return 'left';
        }
    </script>
</body>
</html>
